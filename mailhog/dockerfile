FROM golang:alpine as forge

# Build MailHog:
RUN apk --no-cache add --virtual build-dependencies \
    git \
  && mkdir -p /root/go \
  && export GOPATH=/root/go \
  && go get github.com/mailhog/MailHog

FROM alpine

# Install stunnel  
RUN apk add --no-cache stunnel

# Prepare layout
RUN mkdir -p /opt/mailhog/bin /etc/stunnel 
COPY docker-entrypoint.sh /opt/mailhog/bin/docker-entrypoint.sh
COPY stunnel.conf /etc/stunnel/stunnel.conf
COPY --from=forge /root/go/bin/MailHog /opt/mailhog/bin/mailhog

RUN chmod +x /opt/mailhog/bin/docker-entrypoint.sh \
  && chmod +x /opt/mailhog/bin/mailhog \
  && ln -s /opt/mailhog/bin/mailhog /bin/mailhog \
  && ln -s /opt/mailhog/bin/docker-entrypoint.sh /bin/docker-entrypoint.sh 

ENV CAROOT /var/certs
ENV MH_UI_WEB_PATH mailhog
ENV MH_HOSTNAME mailhog

# Expose the SMTP and HTTP ports:
EXPOSE 465 1025 8025

ENTRYPOINT ["docker-entrypoint.sh"]
